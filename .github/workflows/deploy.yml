name: Deploy to Server

on:
  push:
    branches:
      - deploy

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 20

    - name: Install pnpm
      run: npm install -g pnpm

    - name: Install dependencies
      run: pnpm install

    - name: Build project
      run: pnpm run build

    - name: ðŸš€ Subir `dist/` a la rama `deploy`
      run: |
        git config --global user.email "github-actions@github.com"
        git config --global user.name "GitHub Actions"

        # Crear o cambiar a la rama `deploy`
        git fetch origin deploy || true
        git branch -D deploy || true  # Elimina la rama local si existe
        git checkout --orphan deploy  # Crea una nueva rama sin historial

        # Limpiar el contenido del repositorio y mover `dist/`
        rm -rf .github src node_modules .gitignore package.json pnpm-lock.yaml
        mv dist/* ./
        rm -rf dist

        # Commit y push de la rama `deploy`
        git add .
        git commit -m "ðŸš€ Build Astro - $(date +'%Y-%m-%d %H:%M:%S')"
        git push --force origin deploy
